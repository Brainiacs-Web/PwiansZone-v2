<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>PWians Test Page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
:root {
  --primary-color: #1E40AF;
  --primary-light: #3B82F6;
  --primary-dark: #1E3A8A;
  --secondary-color: #2563EB;
  --accent-color: #9333EA;
  --accent-light: #C084FC;
  --light-bg: #F8FAFC;
  --white: #ffffff;
  --text-color: #1E293B;
  --text-secondary: #64748B;
  --text-muted: #94A3B8;
  --card-shadow: rgba(0, 0, 0, 0.08);
  --card-shadow-hover: rgba(0, 0, 0, 0.15);
  --hover-bg: rgba(30, 64, 175, 0.05);
  --border-color: #E2E8F0;
  --border-light: #F1F5F9;
  --success-color: #10B981;
  --success-light: #34D399;
  --warning-color: #F59E0B;
  --warning-light: #FBBF24;
  --error-color: #EF4444;
  --error-light: #F87171;
  --border-radius: 20px;
  --border-radius-lg: 24px;
  --border-radius-sm: 12px;
  --border-radius-xs: 8px;
  --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  --blur-backdrop: blur(20px) saturate(180%);
  --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  --gradient-accent: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
  --gradient-success: linear-gradient(135deg, var(--success-color) 0%, var(--success-light) 100%);
  --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
  --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
  --shadow-strong: 0 20px 60px rgba(0, 0, 0, 0.15);
}

body.dark-mode {
  --primary-color: #60A5FA;
  --primary-light: #93C5FD;
  --primary-dark: #3B82F6;
  --secondary-color: #3B82F6;
  --accent-color: #C084FC;
  --accent-light: #DDD6FE;
  --light-bg: #0F172A;
  --white: #1E293B;
  --text-color: #E2E8F0;
  --text-secondary: #94A3B8;
  --text-muted: #64748B;
  --card-shadow: rgba(0, 0, 0, 0.4);
  --card-shadow-hover: rgba(0, 0, 0, 0.6);
  --hover-bg: rgba(96, 165, 250, 0.1);
  --border-color: #334155;
  --border-light: #475569;
  --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  --gradient-accent: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
}

/* Enhanced Base Reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

*::before,
*::after {
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
  -webkit-text-size-adjust: 100%;
}

body {
  font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--light-bg);
  color: var(--text-color);
  overflow-x: hidden;
  transition: var(--transition);
  line-height: 1.6;
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  font-feature-settings: "kern" 1, "liga" 1;
}

/* Enhanced App Container */
.app-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  position: relative;
  background: var(--light-bg);
}

.app-container::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 80%, rgba(30, 64, 175, 0.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(147, 51, 234, 0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

/* Enhanced Top Header */
.top-header {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: var(--blur-backdrop);
  border-bottom: 1px solid var(--border-light);
  padding: 16px 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-soft);
  transition: var(--transition);
}

.top-header:hover {
  box-shadow: var(--shadow-medium);
}

.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  animation: slideInDown 0.6s ease-out;
}

.header-row:last-child {
  margin-bottom: 0;
  animation-delay: 0.1s;
}

.user-info {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-info::before {
  content: 'üë§';
  font-size: 16px;
}

.user-info strong {
  color: var(--text-color);
  font-weight: 700;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.timer-section {
  display: flex;
  align-items: center;
  gap: 12px;
}

.timer {
  background: rgba(30, 64, 175, 0.08);
  color: var(--primary-color);
  padding: 10px 16px;
  border-radius: var(--border-radius-sm);
  font-size: 14px;
  font-weight: 700;
  border: 2px solid rgba(30, 64, 175, 0.15);
  display: flex;
  align-items: center;
  gap: 8px;
  transition: var(--transition-bounce);
  font-family: "JetBrains Mono", monospace;
  letter-spacing: 0.5px;
  position: relative;
  overflow: hidden;
}

.timer::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s ease;
}

.timer:hover::before {
  left: 100%;
}

.timer:hover {
  transform: scale(1.05);
  box-shadow: var(--shadow-soft);
}

.submit-btn {
  background: var(--gradient-primary);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: var(--border-radius-sm);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition-bounce);
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-soft);
}

.submit-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.6s ease;
}

.submit-btn:hover::before {
  left: 100%;
}

.submit-btn:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: var(--shadow-medium);
}

.submit-btn:active {
  transform: translateY(-1px) scale(1.02);
}

.test-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  font-size: 12px;
}

.info-item {
  display: flex;
  flex-direction: column;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: var(--border-radius-xs);
  border: 1px solid var(--border-light);
  transition: var(--transition);
}

.info-item:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: translateY(-2px);
  box-shadow: var(--shadow-soft);
}

.info-label {
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  font-size: 10px;
  margin-bottom: 4px;
}

.info-value {
  color: var(--primary-color);
  font-weight: 800;
  font-size: 14px;
  font-family: "JetBrains Mono", monospace;
}

/* Enhanced Navigation Tabs */
.nav-section {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: var(--blur-backdrop);
  border-bottom: 1px solid var(--border-light);
  padding: 0 20px;
  position: sticky;
  top: 80px;
  z-index: 90;
}

.nav-tabs {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 12px 0;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
  display: none;
}

.nav-tab {
  background: rgba(255, 255, 255, 0.8);
  border: 2px solid var(--border-color);
  color: var(--text-color);
  padding: 12px 20px;
  border-radius: 25px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition-bounce);
  white-space: nowrap;
  min-width: fit-content;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.nav-tab::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--gradient-primary);
  transition: left 0.3s ease;
  z-index: -1;
}

.nav-tab.active {
  background: var(--gradient-primary);
  color: white;
  border-color: var(--primary-color);
  transform: scale(1.05);
  box-shadow: var(--shadow-soft);
}

.nav-tab.active::before {
  left: 0;
}

.nav-tab:hover:not(.active) {
  background: var(--hover-bg);
  border-color: var(--primary-color);
  transform: translateY(-2px);
  box-shadow: var(--shadow-soft);
}

/* Enhanced Main Content */
.main-content {
  flex: 1;
  padding: 24px 20px;
  max-width: 100%;
  animation: fadeInUp 0.8s ease-out;
}

/* Enhanced Question Card */
.question-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: var(--blur-backdrop);
  border-radius: var(--border-radius-lg);
  border: 1px solid var(--border-light);
  overflow: hidden;
  box-shadow: var(--shadow-medium);
  position: relative;
  transition: var(--transition-slow);
}

.question-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
  z-index: 1;
}

.question-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-strong);
}

.question-header {
  background: var(--gradient-primary);
  color: white;
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  overflow: hidden;
}

.question-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
  animation: shimmer 3s infinite;
}

.question-number {
  font-size: 16px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.question-number::before {
  content: 'üìù';
  font-size: 18px;
}

.menu-btn {
  background: rgba(255, 255, 255, 0.15);
  border: 2px solid rgba(255, 255, 255, 0.2);
  color: white;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: var(--transition-bounce);
  backdrop-filter: blur(10px);
}

.menu-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: scale(1.1) rotate(90deg);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.question-content {
  padding: 32px 24px;
}

.question-text {
  font-size: 18px;
  line-height: 1.7;
  margin-bottom: 24px;
  color: var(--text-color);
  font-weight: 500;
  position: relative;
}

/* Enhanced LaTeX Styling */
.question-text .MathJax,
.option-text .MathJax {
  font-size: 1.1em !important;
  color: var(--text-color) !important;
}

.question-text .MathJax_Display {
  margin: 20px 0 !important;
  padding: 16px !important;
  background: rgba(30, 64, 175, 0.03) !important;
  border-radius: var(--border-radius-sm) !important;
  border-left: 4px solid var(--primary-color) !important;
}

.question-text mjx-container {
  margin: 8px 0 !important;
}

.question-text mjx-container[display="true"] {
  margin: 20px 0 !important;
  padding: 20px !important;
  background: linear-gradient(135deg, rgba(30, 64, 175, 0.03), rgba(147, 51, 234, 0.03)) !important;
  border-radius: var(--border-radius-sm) !important;
  border: 1px solid rgba(30, 64, 175, 0.1) !important;
  box-shadow: var(--shadow-soft) !important;
}

.question-image,
.option-image {
  max-width: 100%;
  height: auto;
  border-radius: var(--border-radius-sm);
  margin: 16px 0;
  box-shadow: var(--shadow-medium);
  transition: var(--transition);
}

.question-image:hover,
.option-image:hover {
  transform: scale(1.02);
  box-shadow: var(--shadow-strong);
}

/* Enhanced Options */
.options-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin: 24px 0;
}

.option-item {
  background: rgba(255, 255, 255, 0.8);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  padding: 20px;
  cursor: pointer;
  transition: var(--transition-bounce);
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.option-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 6px;
  height: 100%;
  background: var(--gradient-primary);
  transform: scaleY(0);
  transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  transform-origin: bottom;
}

.option-item::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(30, 64, 175, 0.05), transparent);
  transition: left 0.6s ease;
}

.option-item:hover::before,
.option-item.selected::before {
  transform: scaleY(1);
}

.option-item:hover::after {
  left: 100%;
}

.option-item:hover,
.option-item.selected {
  border-color: var(--primary-color);
  background: var(--hover-bg);
  transform: translateX(8px) translateY(-2px);
  box-shadow: var(--shadow-medium);
}

.option-item.selected {
  background: rgba(30, 64, 175, 0.08);
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
}

.option-content {
  display: flex;
  align-items: center;
  gap: 16px;
  width: 100%;
}

.option-radio {
  width: 24px;
  height: 24px;
  accent-color: var(--primary-color);
  cursor: pointer;
  transition: var(--transition);
}

.option-radio:hover {
  transform: scale(1.1);
}

.option-text {
  flex: 1;
  font-size: 15px;
  line-height: 1.6;
  cursor: pointer;
  font-weight: 500;
}

/* Enhanced Input Section */
.input-section {
  background: linear-gradient(135deg, rgba(30, 64, 175, 0.05), rgba(147, 51, 234, 0.05));
  border: 2px solid rgba(30, 64, 175, 0.15);
  border-radius: var(--border-radius-sm);
  padding: 24px;
  margin: 24px 0;
  position: relative;
  overflow: hidden;
}

.input-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--gradient-primary);
}

.input-label {
  display: block;
  font-size: 15px;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.input-field {
  width: 100%;
  max-width: 250px;
  padding: 16px 20px;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  font-size: 18px;
  font-family: "JetBrains Mono", monospace;
  font-weight: 600;
  transition: var(--transition-bounce);
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
}

.input-field:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.15);
  transform: scale(1.02);
  background: white;
}

/* Enhanced Review Section */
.review-section {
  background: linear-gradient(135deg, rgba(147, 51, 234, 0.05), rgba(30, 64, 175, 0.05));
  border: 2px solid rgba(147, 51, 234, 0.15);
  border-radius: var(--border-radius-sm);
  padding: 20px;
  margin: 24px 0;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.review-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--gradient-accent);
}

.review-section:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-soft);
}

.review-checkbox {
  width: 24px;
  height: 24px;
  accent-color: var(--accent-color);
  cursor: pointer;
  transition: var(--transition);
}

.review-checkbox:hover {
  transform: scale(1.1);
}

.review-label {
  font-size: 15px;
  font-weight: 600;
  color: var(--accent-color);
  cursor: pointer;
  flex: 1;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Enhanced Navigation Buttons */
.nav-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  padding: 24px;
  background: linear-gradient(135deg, var(--light-bg), rgba(255, 255, 255, 0.5));
  border-top: 1px solid var(--border-light);
}

.nav-btn {
  padding: 18px 24px;
  border: none;
  border-radius: var(--border-radius-sm);
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition-bounce);
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  min-height: 56px;
  position: relative;
  overflow: hidden;
}

.nav-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.6s ease;
}

.nav-btn:hover::before {
  left: 100%;
}

.nav-btn.primary {
  background: var(--gradient-primary);
  color: white;
  box-shadow: var(--shadow-soft);
}

.nav-btn.secondary {
  background: rgba(255, 255, 255, 0.9);
  color: var(--text-color);
  border: 2px solid var(--border-color);
  backdrop-filter: blur(10px);
}

.nav-btn:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow: var(--shadow-medium);
}

.nav-btn.primary:hover {
  box-shadow: var(--shadow-strong);
}

.nav-btn.secondary:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: rgba(255, 255, 255, 1);
}

.nav-btn:active {
  transform: translateY(-2px) scale(1.01);
}

.nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Enhanced Progress Modal */
.progress-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: var(--blur-backdrop);
  z-index: 1000;
  display: none;
  padding: 20px;
  animation: fadeIn 0.3s ease-out;
}

.progress-content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: var(--blur-backdrop);
  border-radius: var(--border-radius-lg);
  max-width: 500px;
  margin: 0 auto;
  max-height: 85vh;
  overflow-y: auto;
  position: relative;
  margin-top: 5vh;
  box-shadow: var(--shadow-strong);
  border: 1px solid var(--border-light);
  animation: modalSlideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.progress-header {
  background: var(--gradient-primary);
  color: white;
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
  position: relative;
  overflow: hidden;
}

.progress-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
  animation: shimmer 3s infinite;
}

.progress-title {
  font-size: 18px;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 10px;
}

.progress-title::before {
  content: 'üìä';
  font-size: 20px;
}

.close-btn {
  background: rgba(255, 255, 255, 0.15);
  border: 2px solid rgba(255, 255, 255, 0.2);
  color: white;
  font-size: 20px;
  cursor: pointer;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition-bounce);
  backdrop-filter: blur(10px);
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: scale(1.1) rotate(90deg);
}

.progress-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
  gap: 12px;
  padding: 24px;
}

.progress-item {
  aspect-ratio: 1;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition-bounce);
  background: rgba(255, 255, 255, 0.9);
  min-height: 50px;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.progress-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.progress-item:hover::before {
  transform: translateX(100%);
}

.progress-item:hover {
  transform: scale(1.1) rotate(5deg);
  box-shadow: var(--shadow-medium);
  z-index: 1;
}

.progress-actions {
  padding: 24px;
  border-top: 1px solid var(--border-light);
  background: rgba(248, 250, 252, 0.8);
}

.progress-submit {
  width: 100%;
  background: var(--gradient-primary);
  color: white;
  border: none;
  padding: 16px;
  border-radius: var(--border-radius-sm);
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition-bounce);
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: var(--shadow-soft);
}

.progress-submit:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: var(--shadow-medium);
}

/* Enhanced Username Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: var(--blur-backdrop);
  z-index: 1100;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  opacity: 0;
  animation: fadeIn 0.4s forwards;
}

.modal {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: var(--blur-backdrop);
  border-radius: var(--border-radius-lg);
  padding: 40px 32px;
  width: 100%;
  max-width: 450px;
  text-align: center;
  box-shadow: var(--shadow-strong);
  animation: modalSlideUp 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border: 1px solid var(--border-light);
  position: relative;
  overflow: hidden;
}

.modal::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
}

.modal-title {
  font-size: 24px;
  font-weight: 800;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.modal-title::before {
  content: 'üéì';
  font-size: 28px;
  -webkit-text-fill-color: initial;
}

.modal-input {
  width: 100%;
  padding: 18px 24px;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  font-size: 16px;
  font-family: inherit;
  font-weight: 500;
  margin-bottom: 24px;
  transition: var(--transition-bounce);
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
}

.modal-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.15);
  transform: scale(1.02);
  background: white;
}

.modal-btn {
  width: 100%;
  background: var(--gradient-primary);
  color: white;
  border: none;
  padding: 18px;
  border-radius: var(--border-radius-sm);
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition-bounce);
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: var(--shadow-soft);
  position: relative;
  overflow: hidden;
}

.modal-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.6s ease;
}

.modal-btn:hover::before {
  left: 100%;
}

.modal-btn:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: var(--shadow-medium);
}

/* Enhanced Dark Mode Toggle */
.theme-toggle {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--gradient-primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow-medium);
  z-index: 999;
  border: none;
  transition: var(--transition-bounce);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 255, 255, 0.2);
}

.theme-toggle:hover {
  transform: scale(1.15) rotate(180deg);
  box-shadow: var(--shadow-strong);
}

.theme-toggle i {
  font-size: 24px;
  transition: var(--transition);
}

/* Enhanced Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeInUp {
  from { 
    opacity: 0; 
    transform: translateY(30px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

@keyframes slideInDown {
  from { 
    opacity: 0; 
    transform: translateY(-30px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

@keyframes modalSlideUp {
  from { 
    transform: translateY(50px) scale(0.9); 
    opacity: 0; 
  }
  to { 
    transform: translateY(0) scale(1); 
    opacity: 1; 
  }
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes bounce {
  0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
  40%, 43% { transform: translateY(-8px); }
  70% { transform: translateY(-4px); }
  90% { transform: translateY(-2px); }
}

/* Enhanced Status Colors */
.status-answered { 
  background: var(--gradient-success) !important; 
  color: white !important; 
  border-color: var(--success-color) !important;
  animation: pulse 2s infinite;
}

.status-review { 
  background: var(--gradient-accent) !important; 
  color: white !important; 
  border-color: var(--accent-color) !important;
}

.status-visited { 
  background: linear-gradient(135deg, var(--warning-color), var(--warning-light)) !important; 
  color: white !important; 
  border-color: var(--warning-color) !important;
}

.status-answered-review { 
  background: linear-gradient(135deg, var(--text-secondary), var(--text-muted)) !important; 
  color: white !important; 
  border-color: var(--text-secondary) !important;
}

/* Enhanced Responsive Design */
@media (min-width: 768px) {
  body { font-size: 16px; }
  
  .top-header {
    padding: 20px 32px;
  }
  
  .header-row {
    margin-bottom: 16px;
  }
  
  .test-info {
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
  }
  
  .main-content {
    padding: 32px;
    max-width: 900px;
    margin: 0 auto;
  }
  
  .question-content {
    padding: 40px 32px;
  }
  
  .question-text {
    font-size: 20px;
  }
  
  .nav-buttons {
    padding: 32px;
    gap: 24px;
  }
  
  .progress-modal {
    padding: 40px;
  }
  
  .progress-content {
    max-width: 600px;
    margin-top: 3vh;
  }
  
  .progress-grid {
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 16px;
    padding: 32px;
  }
  
  .progress-item {
    min-height: 60px;
    font-size: 16px;
  }
}

@media (min-width: 1024px) {
  .app-container {
    max-width: 1400px;
    margin: 0 auto;
  }
  
  .top-header {
    padding: 24px 40px;
  }
  
  .test-info {
    grid-template-columns: repeat(5, 1fr);
  }
  
  .main-content {
    padding: 40px;
    max-width: 1000px;
  }
  
  .nav-buttons {
    grid-template-columns: 1fr 2fr;
    gap: 32px;
  }
  
  .progress-content {
    max-width: 700px;
  }
  
  .progress-grid {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  }
}

/* Enhanced Touch Improvements */
@media (hover: none) and (pointer: coarse) {
  .nav-tab,
  .option-item,
  .nav-btn,
  .progress-item {
    min-height: 48px;
  }
  
  .menu-btn,
  .theme-toggle {
    width: 48px;
    height: 48px;
  }
  
  .timer,
  .submit-btn {
    padding: 12px 16px;
  }
}

/* Enhanced Accessibility */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

/* Enhanced Focus Styles */
button:focus-visible,
input:focus-visible,
.option-item:focus-within {
  outline: 3px solid var(--primary-color);
  outline-offset: 3px;
  border-radius: var(--border-radius-xs);
}

/* Enhanced Loading States */
.loading {
  opacity: 0.7;
  pointer-events: none;
  position: relative;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 32px;
  height: 32px;
  margin: -16px 0 0 -16px;
  border: 3px solid var(--primary-color);
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
  z-index: 1000;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Enhanced Scrollbar Styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--light-bg);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--primary-color);
  border-radius: 4px;
  transition: var(--transition);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

/* Enhanced Print Styles */
@media print {
  .theme-toggle,
  .nav-buttons,
  .progress-modal,
  .modal-overlay {
    display: none !important;
  }
  
  .question-card {
    box-shadow: none !important;
    border: 2px solid var(--border-color) !important;
  }
  
  body {
    background: white !important;
    color: black !important;
  }
}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Enhanced Top Header -->
    <header class="top-header">
      <div class="header-row">
        <div class="user-info">
          <strong id="logged-username">--</strong> ‚Ä¢ <span id="logged-batch">--</span>
        </div>
        <div class="timer-section">
          <div class="timer" id="timer">
            <i class="fas fa-clock"></i>
            <span id="time-left">00:00:00</span>
          </div>
          <button class="submit-btn" onclick="submitTest()">
            <i class="fas fa-paper-plane"></i> Submit
          </button>
        </div>
      </div>
      <div class="test-info">
        <div class="info-item">
          <span class="info-label">Test</span>
          <span class="info-value" id="test-name">--</span>
        </div>
        <div class="info-item">
          <span class="info-label">Subject</span>
          <span class="info-value" id="current-subject">--</span>
        </div>
        <div class="info-item">
          <span class="info-label">Question</span>
          <span class="info-value">
            <span id="current-question-index">0</span>/<span id="total-questions">0</span>
          </span>
        </div>
      </div>
    </header>

    <!-- Enhanced Navigation Tabs -->
    <nav class="nav-section">
      <div class="nav-tabs" id="subject-buttons"></div>
    </nav>

    <!-- Enhanced Main Content -->
    <main class="main-content" id="content" style="filter: blur(5px);">
      <div class="question-card" id="question-card">
        <div class="question-header">
          <div class="question-number">Question 1</div>
          <button class="menu-btn" onclick="toggleProgress()">
            <i class="fas fa-bars"></i>
          </button>
        </div>
        <div class="question-content">
          <p>Loading question...</p>
        </div>
      </div>
    </main>

    <!-- Enhanced Dark Mode Toggle Button -->
    <button class="theme-toggle" id="theme-toggle">
      <i class="fas fa-moon"></i>
    </button>
  </div>

  <!-- Enhanced Progress Modal -->
  <div class="progress-modal" id="progress-modal">
    <div class="progress-content">
      <div class="progress-header">
        <h3 class="progress-title">Question Progress</h3>
        <button class="close-btn" onclick="toggleProgress()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="progress-grid" id="question-progress"></div>
      <div class="progress-actions">
        <button class="progress-submit" onclick="submitTest()">
          <i class="fas fa-paper-plane"></i> Submit Test
        </button>
      </div>
    </div>
  </div>

  <!-- Enhanced Username Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2 class="modal-title">Welcome to PWians Test</h2>
      <input type="text" class="modal-input" id="username" placeholder="Enter your username">
      <button class="modal-btn" onclick="validateCredentials()">
        <i class="fas fa-arrow-right"></i> Start Test
      </button>
    </div>
  </div>

<!-- Enhanced MathJax Configuration -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['\$$', '\$$'], ['$', '$']],
    displayMath: [['\\[', '\\]'], ['$$', '$$']],
    processEscapes: true,
    processEnvironments: true,
    packages: {
      '[+]': ['ams', 'newcommand', 'configmacros', 'action', 'require', 'autoload', 'color', 'cancel', 'mhchem', 'physics']
    },
    macros: {
      // Common mathematical macros
      RR: "\\mathbb{R}",
      NN: "\\mathbb{N}",
      ZZ: "\\mathbb{Z}",
      QQ: "\\mathbb{Q}",
      CC: "\\mathbb{C}",
      FF: "\\mathbb{F}",
      // Vectors and matrices
      vec: ["\\mathbf{#1}", 1],
      mat: ["\\mathbf{#1}", 1],
      // Derivatives
      dd: ["\\frac{d#1}{d#2}", 2],
      pp: ["\\frac{\\partial#1}{\\partial#2}", 2],
      // Common functions
      sin: "\\operatorname{sin}",
      cos: "\\operatorname{cos}",
      tan: "\\operatorname{tan}",
      log: "\\operatorname{log}",
      ln: "\\operatorname{ln}",
      exp: "\\operatorname{exp}",
      // Physics
      hbar: "\\hslash",
      ket: ["|#1\\rangle", 1],
      bra: ["\\langle#1|", 1],
      braket: ["\\langle#1|#2\\rangle", 2],
      // Chemistry
      ce: ["\\require{mhchem}\\ce{#1}", 1]
    }
  },
  svg: {
    fontCache: 'global',
    displayAlign: 'center',
    displayIndent: '0',
    scale: 1.1,
    minScale: 0.8,
    mtextInheritFont: true,
    merrorInheritFont: true,
    mathmlSpacing: false,
    skipAttributes: {},
    exFactor: 0.5,
    displayOverflow: 'linebreak',
    linebreaks: { automatic: true, width: '90%' }
  },
  chtml: {
    scale: 1.1,
    minScale: 0.8,
    mtextInheritFont: true,
    merrorInheritFont: true,
    mathmlSpacing: false,
    displayAlign: 'center',
    displayIndent: '0'
  },
  options: {
    enableMenu: false,
    menuOptions: {
      settings: {
        zoom: 'Click',
        zscale: '150%'
      }
    }
  },
  startup: {
    ready: () => {
      console.log('Enhanced MathJax loaded with advanced LaTeX support');
      MathJax.startup.defaultReady();
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 1. Read URL params ‚Üí testID, batchName; initialize username as blank
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const params = new URLSearchParams(window.location.search);
  const testID = params.get("test") || "";
  let batchName = params.get("batchName") || "";
  let username = "";

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 2. State Management
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let testData = {};
  let subjectsArr = [];
  let questions = [];
  let currentSubject = "";
  let currentQuestionIndex = 0;
  let timeLeft = 0, timerInterval = null;
  let tabSwitchCount = 0, maxTabSwitches = 5;
  let isDarkMode = localStorage.getItem('darkMode') === 'true';

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 3. Enhanced LaTeX Rendering Helper with Advanced Pattern Recognition
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderLatex(str) {
    if (!str) return "‚Äî";

    // 1) Detect existing TeX delimiters
    const alreadyHasDelimiters =
         /\\$$.+?\\$$/.test(str)         // $$ ‚Ä¶ $$
      || /\\\[.+?\\\]/.test(str)         // \[ ‚Ä¶ \]
      || /\$\$[\s\S]+?\$\$/.test(str)    // $$ ‚Ä¶ $$
      || /\$[^$\n]+\$/.test(str)         // $ ‚Ä¶ $ (single dollar)
      || /\\begin\{.+?\}[\s\S]+?\\end\{.+?\}/.test(str);  // any \begin{‚Ä¶} ‚Ä¶ \end{‚Ä¶}

    if (alreadyHasDelimiters) {
      return str;
    }

    // 2) Enhanced pattern detection for mathematical expressions
    const advancedMathPatterns = [
      // Fractions
      /\\frac\s*\{[^}]+\}\s*\{[^}]+\}/,
      /\\dfrac\s*\{[^}]+\}\s*\{[^}]+\}/,
      /\\tfrac\s*\{[^}]+\}\s*\{[^}]+\}/,
      /\\cfrac\s*\{[^}]+\}\s*\{[^}]+\}/,
      
      // Roots and powers
      /\\sqrt\s*(\[[^\]]*\])?\s*\{[^}]+\}/,
      /\\sqrt\[[^\]]+\]\{[^}]+\}/,
      /[A-Za-z0-9_]\^[\{][^}]+[\}]/,
      /[A-Za-z0-9_]_[\{][^}]+[\}]/,
      
      // Integrals and sums
      /\\int(_\{[^}]*\})?(\^\{[^}]*\})?/,
      /\\iint(_\{[^}]*\})?(\^\{[^}]*\})?/,
      /\\iiint(_\{[^}]*\})?(\^\{[^}]*\})?/,
      /\\oint(_\{[^}]*\})?(\^\{[^}]*\})?/,
      /\\sum(_\{[^}]*\})?(\^\{[^}]*\})?/,
      /\\prod(_\{[^}]*\})?(\^\{[^}]*\})?/,
      /\\lim(_\{[^}]*\})?/,
      
      // Matrices and arrays
      /\\begin\{(matrix|pmatrix|bmatrix|vmatrix|Vmatrix|array)\}/,
      /\\begin\{(align|equation|gather|multline)\*?\}/,
      
      // Greek letters and special symbols
      /\\(alpha|beta|gamma|delta|epsilon|varepsilon|zeta|eta|theta|vartheta|iota|kappa|lambda|mu|nu|xi|pi|varpi|rho|varrho|sigma|varsigma|tau|upsilon|phi|varphi|chi|psi|omega)/,
      /\\(Alpha|Beta|Gamma|Delta|Epsilon|Zeta|Eta|Theta|Iota|Kappa|Lambda|Mu|Nu|Xi|Pi|Rho|Sigma|Tau|Upsilon|Phi|Chi|Psi|Omega)/,
      
      // Mathematical operators
      /\\(cdot|times|div|pm|mp|ast|star|circ|bullet|cap|cup|sqcap|sqcup|vee|wedge|setminus|wr|diamond|bigtriangleup|bigtriangledown|triangleleft|triangleright|lhd|rhd|unlhd|unrhd|oplus|ominus|otimes|oslash|odot|bigcirc|dagger|ddagger|amalg)/,
      
      // Relations
      /\\(leq|geq|equiv|models|prec|succ|sim|perp|preceq|succeq|simeq|mid|ll|gg|asymp|parallel|subset|supset|approx|bowtie|subseteq|supseteq|cong|Join|sqsubset|sqsupset|neq|smile|sqsubseteq|sqsupseteq|doteq|frown|in|ni|propto|vdash|dashv)/,
      
      // Arrows
      /\\(leftarrow|rightarrow|leftrightarrow|Leftarrow|Rightarrow|Leftrightarrow|mapsto|hookleftarrow|hookrightarrow|leftharpoonup|leftharpoondown|rightharpoonup|rightharpoondown|rightleftharpoons|iff|uparrow|downarrow|updownarrow|Uparrow|Downarrow|Updownarrow|nearrow|searrow|swarrow|nwarrow)/,
      
      // Functions
      /\\(sin|cos|tan|cot|sec|csc|arcsin|arccos|arctan|sinh|cosh|tanh|coth|log|ln|lg|exp|max|min|sup|inf|lim|limsup|liminf|det|ker|dim|hom|arg|deg|gcd)/,
      
      // Accents and decorations
      /\\(hat|check|breve|acute|grave|tilde|bar|vec|dot|ddot|widehat|widetilde|overline|underline)\s*\{[^}]+\}/,
      
      // Delimiters
      /\$$left|right)\s*[\($$\[\]|\{\}\\|]/,
      /\$$big|Big|bigg|Bigg)[lr]?\s*[\($$\[\]|\{\}\\|]/,
      
      // Spacing and formatting
      /\\(quad|qquad|,|:|;|!|\s)/,
      /\\(text|mathrm|mathit|mathbf|mathsf|mathtt|mathcal|mathscr|mathfrak|mathbb)\s*\{[^}]+\}/,
      
      // Chemistry (mhchem)
      /\\ce\s*\{[^}]+\}/,
      
      // Physics
      /\\(hbar|ell|wp|Re|Im|partial|nabla|Box|triangle|clubsuit|diamondsuit|heartsuit|spadesuit)/,
      /\\(ket|bra|braket)\s*\{[^}]+\}/,
      
      // Complex expressions
      /[A-Za-z]+_\{[^}]+\}\^\{[^}]+\}/,
      /\{[^}]*\\[a-zA-Z]+[^}]*\}/,
      
      // Simple patterns
      /\\[a-zA-Z]+/,
      /[A-Za-z]+_[A-Za-z0-9]/,
      /[A-Za-z]+\^[A-Za-z0-9]/,
      /\{[^}]*[\\][^}]*\}/
    ];

    // Check if any advanced pattern matches
    const hasAdvancedMath = advancedMathPatterns.some(pattern => pattern.test(str));

    if (hasAdvancedMath) {
      // For complex expressions, use display math
      if (str.length > 50 || /\\(begin|int|sum|prod|frac|sqrt)/.test(str)) {
        return `\\[${str}\\]`;
      } else {
        return `\$$${str}\$$`;
      }
    }

    // 3) Otherwise leave it unchanged
    return str;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 4. Enhanced Dark Mode with Smooth Transitions
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (isDarkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
  }

  document.getElementById('theme-toggle').addEventListener('click', () => {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode', isDarkMode);
    document.getElementById('theme-toggle').innerHTML = isDarkMode 
      ? '<i class="fas fa-sun"></i>' 
      : '<i class="fas fa-moon"></i>';
    localStorage.setItem('darkMode', isDarkMode);
    
    // Add smooth transition effect
    document.body.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      document.body.style.transition = '';
    }, 500);
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 5. Show Batch Code in Header
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById("logged-batch").textContent = batchName;

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 6. Validate Credentials (Username) & Load Test Data
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.validateCredentials = async () => {
    const u = document.getElementById("username").value.trim();
    if (!u) {
      showToast("Please enter your username.", "error");
      return;
    }
    username = u;
    document.getElementById("logged-username").textContent = username;
    
    // Enhanced modal close animation
    const modal = document.getElementById("modal-overlay");
    modal.style.animation = 'fadeOut 0.3s ease-out forwards';
    setTimeout(() => {
      modal.style.display = "none";
      modal.style.animation = '';
    }, 300);
    
    document.getElementById("content").style.filter = "none";
    document.getElementById("content").style.animation = 'fadeInUp 0.6s ease-out';
    
    await loadTestSeriesData();
  };

  async function loadTestSeriesData() {
    try {
      showLoading(true);
      const res = await fetch(`/api/testSeries/${testID}`);
      if (!res.ok) throw new Error("Fetch failed");
      testData = await res.json();

      // Populate test name & subjects; set timer
      document.getElementById("test-name").textContent = testData.testName;
      subjectsArr = testData.subjects;
      timeLeft = (testData.testDuration || 90) * 60;

      buildSubjectButtons();
      currentSubject = subjectsArr[0];

      // Directly load questions (no separate chapter logic in this version)
      await loadQuestions();

      updateTimerDisplay();
      startTimer();
    } catch (e) {
      console.error(e);
      showToast("Failed to load test. Please refresh and try again.", "error");
    } finally {
      showLoading(false);
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 7. Build & Update Subject Tabs with Enhanced Animations
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildSubjectButtons() {
    const container = document.getElementById("subject-buttons");
    container.innerHTML = "";
    subjectsArr.forEach((sub, index) => {
      const btn = document.createElement("button");
      btn.className = "nav-tab";
      btn.textContent = sub;
      btn.style.animationDelay = `${index * 0.1}s`;
      btn.style.animation = 'slideInDown 0.5s ease-out forwards';
      btn.onclick = () => {
        currentSubject = sub;
        updateSubjectButtons();
        loadQuestions();
      };
      container.appendChild(btn);
    });
    updateSubjectButtons();
  }

  function updateSubjectButtons() {
    document.querySelectorAll("#subject-buttons .nav-tab")
      .forEach(btn => btn.classList.toggle("active", btn.textContent === currentSubject));
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 8. Load Questions for Current Subject ‚Üí Sort MCQ first, Track Visited
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadQuestions() {
    showLoading(true);

    const questionMap = testData.questions[currentSubject] || {};
    questions = Object.values(questionMap);

    // Sort: MCQs (with options) first, then numerical-input questions
    questions.sort((a, b) => {
      const aIsInput = !Array.isArray(a.options) || !a.options.length;
      const bIsInput = !Array.isArray(b.options) || !b.options.length;
      return aIsInput - bIsInput;
    });

    currentQuestionIndex = 0;
    if (questions.length) {
      markAsVisited(questions[0].questionId);
    }

    displayQuestion();
    updateNavInfo();
    updateProgress();
    showLoading(false);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 9. Enhanced Question Rendering with Advanced MathJax Integration
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function displayQuestion() {
    const question = questions[currentQuestionIndex];
    const container = document.getElementById("question-card");

    if (!question) {
      container.innerHTML = `
        <div class="question-header">
          <div class="question-number">No Questions</div>
        </div>
        <div class="question-content">
          <p>No questions available for this section.</p>
        </div>
      `;
      return;
    }

    const isImageURL = (str) => /https?:\/\/.*\.(png|jpe?g|gif|svg)$/i.test(str);
    const savedAnswer = getSavedAnswer(question.questionId);
    const isReviewed = getSavedReview(question.questionId);

    // Build question header + text with enhanced animations
    let questionContent = `
      <div class="question-header">
        <div class="question-number">Question ${currentQuestionIndex + 1}</div>
        <button class="menu-btn" onclick="toggleProgress()">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      <div class="question-content">
        <div class="question-text">
          ${
            isImageURL(question.question)
              ? `<img src="${question.question}" class="question-image" alt="Question image" loading="lazy"/>`
              : renderLatex(question.question)
          }
        </div>
        
        <div class="review-section">
          <input type="checkbox" class="review-checkbox"
                 id="review-checkbox"
                 ${isReviewed ? "checked" : ""}/>
          <label for="review-checkbox" class="review-label">
            <i class="fas fa-bookmark"></i> Mark for Review
          </label>
        </div>
    `;

    // If MCQ (array of options)
    if (Array.isArray(question.options) && question.options.length) {
      questionContent += `<div class="options-container">`;

      question.options.forEach((option, index) => {
        const optionValue = String.fromCharCode(65 + index);
        const isSelected = savedAnswer === optionValue;

        questionContent += `
          <div class="option-item ${isSelected ? 'selected' : ''}"
               onclick="selectOption('${question.questionId}','${optionValue}', this)"
               style="animation-delay: ${index * 0.1}s">
            <div class="option-content">
              <input type="radio"
                     class="option-radio"
                     name="opt_${question.questionId}"
                     value="${optionValue}"
                     ${isSelected ? 'checked' : ''}
                     onchange="handleOptionChange(event,'${question.questionId}')">
              <div class="option-text">
                ${
                  isImageURL(option)
                    ? `<img src="${option}" class="option-image" alt="Option ${optionValue}" loading="lazy"/>`
                    : `${optionValue}. ${renderLatex(option)}`
                }
              </div>
            </div>
          </div>
        `;
      });

      questionContent += `</div>`; // Close options-container
    }
    // Else: numerical-input question
    else {
      questionContent += `
        <div class="input-section">
          <label class="input-label">
            <i class="fas fa-edit"></i> Your Answer:
          </label>
          <input type="number"
                 class="input-field"
                 id="answer-input"
                 value="${savedAnswer}"
                 placeholder="Enter your answer"
                 step="any"/>
        </div>
      `;
    }

    // Navigation buttons (Previous + Save & Next/Finish)
    questionContent += `
        <div class="nav-buttons">
          <button class="nav-btn secondary"
                  onclick="goToPrevious()"
                  ${currentQuestionIndex === 0 ? 'disabled' : ''}>
            <i class="fas fa-arrow-left"></i> Previous
          </button>
          <button class="nav-btn primary" onclick="saveAndNext()">
            ${
              currentQuestionIndex === questions.length - 1
                ? '<i class="fas fa-flag-checkered"></i> Save & Finish'
                : '<i class="fas fa-arrow-right"></i> Save & Next'
            }
          </button>
        </div>
      </div>
    `;

    // Inject into DOM with fade animation
    container.style.opacity = '0';
    container.innerHTML = questionContent;
    
    // Animate options
    const options = container.querySelectorAll('.option-item');
    options.forEach((option, index) => {
      option.style.animation = `fadeInUp 0.5s ease-out ${index * 0.1}s forwards`;
    });

    // Fade in the container
    setTimeout(() => {
      container.style.transition = 'opacity 0.3s ease';
      container.style.opacity = '1';
    }, 100);

    // ‚îÄ‚îÄ Enhanced MathJax typesetting with error handling ‚îÄ‚îÄ
    if (window.MathJax && window.MathJax.typesetPromise) {
      MathJax.typesetPromise([container])
        .then(() => {
          console.log('MathJax rendering completed successfully');
          // Apply enhanced styling to rendered math
          const mathElements = container.querySelectorAll('mjx-container');
          mathElements.forEach(el => {
            el.style.transition = 'all 0.3s ease';
            el.addEventListener('mouseenter', () => {
              el.style.transform = 'scale(1.05)';
            });
            el.addEventListener('mouseleave', () => {
              el.style.transform = 'scale(1)';
            });
          });
        })
        .catch(err => {
          console.error("Enhanced MathJax rendering error:", err);
          showToast("Mathematical expressions may not display correctly", "warning");
        });
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 10. Enhanced Option Selection with Smooth Animations
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function selectOption(questionId, value, element) {
    // Deselect all with animation
    document.querySelectorAll('.option-item').forEach(opt => {
      opt.classList.remove('selected');
      opt.style.transform = '';
    });
    
    // Mark this as selected with enhanced animation
    element.classList.add('selected');
    element.style.transform = 'translateX(8px) translateY(-2px) scale(1.02)';

    // Update the corresponding radio input
    const radio = element.querySelector('input[type="radio"]');
    radio.checked = true;

    // Persist in LocalStorage
    saveAnswer(questionId, value);
    
    // Visual feedback
    showToast(`Option ${value} selected`, "success");
  }

  function handleOptionChange(event, questionId) {
    saveAnswer(questionId, event.target.value);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 11. Enhanced Navigation with Smooth Transitions
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.saveAndNext = () => {
    const question = questions[currentQuestionIndex];
    
    // Save numeric answer if present
    const answerInput = document.getElementById("answer-input");
    if (answerInput) {
      const value = answerInput.value.trim();
      if (value) saveAnswer(question.questionId, value);
      else removeAnswer(question.questionId);
    }
    
    // Save review checkbox state
    const reviewCheckbox = document.getElementById("review-checkbox");
    if (reviewCheckbox) saveReview(question.questionId, reviewCheckbox.checked);

    // Advance index or switch subject with animation
    if (currentQuestionIndex < questions.length - 1) {
      currentQuestionIndex++;
      markAsVisited(questions[currentQuestionIndex].questionId);
    } else {
      // Move to next subject or notify completion
      const currentIndex = subjectsArr.indexOf(currentSubject);
      if (currentIndex < subjectsArr.length - 1) {
        currentSubject = subjectsArr[currentIndex + 1];
        updateSubjectButtons();
        loadQuestions();
        showToast(`Switched to ${currentSubject}`, "info");
        return;
      } else {
        showToast("üéâ You have completed all questions!", "success");
        return;
      }
    }

    displayQuestion();
    updateNavInfo();
    updateProgress();
  };

  window.goToPrevious = () => {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      displayQuestion();
      updateNavInfo();
      updateProgress();
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 12. Update Navigation Info with Enhanced Styling
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateNavInfo() {
    document.getElementById("current-subject").textContent = currentSubject;
    document.getElementById("current-question-index").textContent = currentQuestionIndex + 1;
    document.getElementById("total-questions").textContent = questions.length;
    
    // Add progress bar animation
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    const progressBar = document.querySelector('.question-header::before');
    if (progressBar) {
      progressBar.style.width = `${progress}%`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 13. Enhanced Progress Modal with Advanced Animations
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateProgress() {
    const container = document.getElementById("question-progress");
    container.innerHTML = "";

    questions.forEach((question, index) => {
      const item = document.createElement("div");
      item.className = "progress-item";
      item.textContent = index + 1;
      item.style.animationDelay = `${index * 0.05}s`;

      const hasAnswer = !!getSavedAnswer(question.questionId);
      const isReviewed = getSavedReview(question.questionId);
      const isVisited  = getSavedVisited(question.questionId);

      if (hasAnswer && isReviewed) {
        item.classList.add("status-answered-review");
        item.title = "Answered and marked for review";
      } else if (hasAnswer) {
        item.classList.add("status-answered");
        item.title = "Answered";
      } else if (isReviewed) {
        item.classList.add("status-review");
        item.title = "Marked for review";
      } else if (isVisited) {
        item.classList.add("status-visited");
        item.title = "Visited";
      } else {
        item.title = "Not visited";
      }

      // Current question highlight
      if (index === currentQuestionIndex) {
        item.style.border = '3px solid var(--accent-color)';
        item.style.boxShadow = '0 0 15px rgba(147, 51, 234, 0.4)';
      }

      item.onclick = () => {
        currentQuestionIndex = index;
        markAsVisited(question.questionId);
        displayQuestion();
        updateNavInfo();
        updateProgress();
        toggleProgress(); // auto‚Äêclose progress on mobile
        showToast(`Jumped to Question ${index + 1}`, "info");
      };

      container.appendChild(item);
    });
  }

  window.toggleProgress = () => {
    const modal = document.getElementById("progress-modal");
    const isVisible = modal.style.display === "block";
    
    if (isVisible) {
      modal.style.animation = 'fadeOut 0.3s ease-out forwards';
      setTimeout(() => {
        modal.style.display = "none";
        modal.style.animation = '';
      }, 300);
    } else {
      modal.style.display = "block";
      modal.style.animation = 'fadeIn 0.3s ease-out forwards';
      updateProgress();
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 14. LocalStorage Helpers: Answer, Review, Visited
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function saveAnswer(questionId, answer) {
    const key = `response_${currentSubject}_${questionId}`;
    localStorage.setItem(key, answer);
    console.log(`Saved answer: ${key} = ${answer}`);
  }
  
  function getSavedAnswer(questionId) {
    const key = `response_${currentSubject}_${questionId}`;
    return localStorage.getItem(key) || "";
  }
  
  function removeAnswer(questionId) {
    const key = `response_${currentSubject}_${questionId}`;
    localStorage.removeItem(key);
  }

  function saveReview(questionId, isReviewed) {
    const key = `review_${currentSubject}_${questionId}`;
    if (isReviewed) localStorage.setItem(key, "true");
    else localStorage.removeItem(key);
  }
  
  function getSavedReview(questionId) {
    const key = `review_${currentSubject}_${questionId}`;
    return localStorage.getItem(key) === "true";
  }

  function markAsVisited(questionId) {
    const key = `visited_${currentSubject}_${questionId}`;
    localStorage.setItem(key, "true");
  }
  
  function getSavedVisited(questionId) {
    const key = `visited_${currentSubject}_${questionId}`;
    return localStorage.getItem(key) === "true";
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 15. Enhanced Timer with Visual Alerts
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateTimerDisplay() {
    const hours   = String(Math.floor(timeLeft / 3600)).padStart(2, '0');
    const minutes = String(Math.floor((timeLeft % 3600) / 60)).padStart(2, '0');
    const seconds = String(timeLeft % 60).padStart(2, '0');
    document.getElementById("time-left").textContent = `${hours}:${minutes}:${seconds}`;

    const timerEl = document.getElementById("timer");
    
    // Enhanced visual alerts
    if (timeLeft <= 300) { // last 5 min ‚Üí red alert with pulse
      timerEl.style.background = "rgba(239, 68, 68, 0.15)";
      timerEl.style.color = "var(--error-color)";
      timerEl.style.borderColor = "var(--error-color)";
      timerEl.style.animation = "pulse 1s infinite";
      
      if (timeLeft % 60 === 0) { // Every minute in last 5 minutes
        showToast(`‚ö†Ô∏è ${Math.floor(timeLeft / 60)} minutes remaining!`, "error");
      }
    } else if (timeLeft <= 600) { // last 10 min ‚Üí orange
      timerEl.style.background = "rgba(245, 158, 11, 0.15)";
      timerEl.style.color = "var(--warning-color)";
      timerEl.style.borderColor = "var(--warning-color)";
      timerEl.style.animation = "none";
    } else {
      timerEl.style.background = "rgba(30, 64, 175, 0.08)";
      timerEl.style.color = "var(--primary-color)";
      timerEl.style.borderColor = "rgba(30, 64, 175, 0.15)";
      timerEl.style.animation = "none";
    }
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        showToast("‚è∞ Time's up! Auto-submitting test...", "error");
        submitTest(true);
      }
    }, 1000);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 16. Enhanced Tab‚ÄêSwitch Detection
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      tabSwitchCount++;
      const remaining = maxTabSwitches - tabSwitchCount;
      
      if (tabSwitchCount >= maxTabSwitches) {
        showToast("üö´ Maximum tab switches exceeded. Auto-submitting...", "error");
        submitTest(true);
      } else {
        showToast(
          `‚ö†Ô∏è Warning: ${remaining} tab switch${remaining !== 1 ? 'es' : ''} remaining before auto‚Äêsubmit.`,
          "warning"
        );
      }
    }
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 17. Enhanced Submit Test with Better UX
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.submitTest = async (auto = false) => {
    // Pre-save current state
    const currentQ = questions[currentQuestionIndex];
    if (currentQ) {
      const answerInput = document.getElementById("answer-input");
      if (answerInput) {
        const val = answerInput.value.trim();
        if (val) {
          saveAnswer(currentQ.questionId, val);
        } else {
          removeAnswer(currentQ.questionId);
        }
      }
      const reviewCheckbox = document.getElementById("review-checkbox");
      if (reviewCheckbox) {
        saveReview(currentQ.questionId, reviewCheckbox.checked);
      }
    }

    // Enhanced confirmation dialog
    if (!auto) {
      const totalAnswered = getTotalAnsweredQuestions();
      const totalQuestions = getTotalQuestions();
      const unanswered = totalQuestions - totalAnswered;
      
      let confirmMessage = `Are you sure you want to submit the test?\n\n`;
      confirmMessage += `üìä Progress Summary:\n`;
      confirmMessage += `‚úÖ Answered: ${totalAnswered}/${totalQuestions}\n`;
      if (unanswered > 0) {
        confirmMessage += `‚ùå Unanswered: ${unanswered}\n`;
      }
      confirmMessage += `\nThis action cannot be undone.`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
    }

    try {
      showLoading(true);
      showToast(auto ? "Auto-submitting test..." : "Submitting test...", "info");

      // Build payload from LocalStorage for all subjects/questions
      const payload = {};
      for (const subject of subjectsArr) {
        payload[subject] = {};
        const qMap = testData.questions[subject] || {};
        Object.values(qMap).forEach(q => {
          const key = `response_${subject}_${q.questionId}`;
          const stored = localStorage.getItem(key);
          payload[subject][q.questionId] = {
            questionId: q.questionId,
            selectedAnswer: stored || null
          };
        });
      }

      console.log('Submitting enhanced payload:', payload);

      // POST to server
      const response = await fetch(`/api/tests/${testID}/submit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          batchName,
          username,
          responses: payload,
          submissionType: auto ? 'auto' : 'manual',
          timeRemaining: timeLeft,
          tabSwitchCount
        })
      });

      if (!response.ok) {
        throw new Error(`Submission failed: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('Enhanced submission result:', result);

      // Cleanup & Redirect with enhanced feedback
      localStorage.clear();
      clearInterval(timerInterval);
      
      const successMessage = auto 
        ? "ü§ñ Test auto-submitted successfully!" 
        : "üéâ Test submitted successfully!";
      showToast(successMessage, "success");
      
      // Disable all interactions
      document.body.style.pointerEvents = 'none';
      document.body.style.opacity = '0.7';
      
      setTimeout(() => {
        window.location.href = auto
          ? "/Results/"
          : `/Results/?test=${testID}&batch=${encodeURIComponent(batchName)}&username=${encodeURIComponent(username)}`;
      }, 2000);

    } catch (error) {
      console.error("Enhanced submission error:", error);
      showToast("‚ùå Failed to submit test. Please try again.", "error");
      showLoading(false);
    }
  };

  // Helper functions for submission stats
  function getTotalAnsweredQuestions() {
    let count = 0;
    for (const subject of subjectsArr) {
      const qMap = testData.questions[subject] || {};
      Object.values(qMap).forEach(q => {
        const key = `response_${subject}_${q.questionId}`;
        if (localStorage.getItem(key)) count++;
      });
    }
    return count;
  }

  function getTotalQuestions() {
    let count = 0;
    for (const subject of subjectsArr) {
      const qMap = testData.questions[subject] || {};
      count += Object.keys(qMap).length;
    }
    return count;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 18. Enhanced Loading & Toast System
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showLoading(show) {
    const content = document.getElementById("content");
    if (show) {
      content.classList.add("loading");
      content.style.filter = "blur(2px)";
    } else {
      content.classList.remove("loading");
      content.style.filter = "none";
    }
  }

  function showToast(message, type = "info") {
    const toast = document.createElement("div");
    const icons = {
      info: "‚ÑπÔ∏è",
      success: "‚úÖ",
      warning: "‚ö†Ô∏è",
      error: "‚ùå"
    };
    
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${
        type === "error"   ? "var(--error-color)" :
        type === "warning" ? "var(--warning-color)" :
        type === "success" ? "var(--success-color)" : "var(--primary-color)"
      };
      color: white;
      padding: 16px 24px;
      border-radius: var(--border-radius-sm);
      font-size: 14px; 
      font-weight: 600;
      z-index: 10000;
      box-shadow: var(--shadow-medium);
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 350px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
    `;
    
    toast.innerHTML = `${icons[type] || icons.info} ${message}`;
    document.body.appendChild(toast);

    // Slide in with bounce
    setTimeout(() => {
      toast.style.transform = "translateX(0)";
    }, 100);

    // Auto‚Äêremove with fade
    setTimeout(() => {
      toast.style.transform = "translateX(100%)";
      toast.style.opacity = "0";
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 400);
    }, 4000);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 19. Enhanced Keyboard Navigation & Touch Gestures
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('keydown', (e) => {
    // Prevent default browser shortcuts that might interfere
    if (e.ctrlKey && (e.key === 'r' || e.key === 'R')) {
      e.preventDefault();
      showToast("Page refresh is disabled during test", "warning");
      return;
    }
    
    if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
      e.preventDefault();
      goToPrevious();
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      saveAndNext();
    } else if (e.key === 'Escape') {
      const modal = document.getElementById("progress-modal");
      if (modal.style.display === "block") toggleProgress();
    } else if (e.key >= '1' && e.key <= '4') {
      // Quick option selection with number keys
      const optionIndex = parseInt(e.key) - 1;
      const options = document.querySelectorAll('.option-item');
      if (options[optionIndex]) {
        options[optionIndex].click();
      }
    }
  });

  // Enhanced touch gestures
  let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0;
  
  document.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  });
  
  document.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipe();
  });
  
  function handleSwipe() {
    const swipeThreshold = 80;
    const verticalThreshold = 100;
    const diffX = touchStartX - touchEndX;
    const diffY = touchStartY - touchEndY;
    
    // Only process horizontal swipes (ignore vertical scrolling)
    if (Math.abs(diffX) > swipeThreshold && Math.abs(diffY) < verticalThreshold) {
      if (diffX > 0) {
        saveAndNext(); // Swipe left ‚Üí Next
        showToast("Swiped to next question", "info");
      } else {
        goToPrevious(); // Swipe right ‚Üí Previous
        showToast("Swiped to previous question", "info");
      }
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 20. Enhanced Initial Setup & Error Handling
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('DOMContentLoaded', () => {
    const usernameInput = document.getElementById("username");
    if (usernameInput) {
      usernameInput.focus();
      usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') validateCredentials();
      });
      
      // Enhanced input validation
      usernameInput.addEventListener('input', (e) => {
        const value = e.target.value;
        const isValid = value.length >= 3 && /^[a-zA-Z0-9_]+$/.test(value);
        const submitBtn = document.querySelector('.modal-btn');
        
        if (isValid) {
          submitBtn.style.opacity = '1';
          submitBtn.style.pointerEvents = 'auto';
          e.target.style.borderColor = 'var(--success-color)';
        } else {
          submitBtn.style.opacity = '0.6';
          submitBtn.style.pointerEvents = 'none';
          e.target.style.borderColor = 'var(--error-color)';
        }
      });
    }
    
    // Add global error handler
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.error);
      showToast("An unexpected error occurred. Please refresh if issues persist.", "error");
    });
    
    // Add unload warning
    window.addEventListener('beforeunload', (e) => {
      if (timeLeft > 0) {
        e.preventDefault();
        e.returnValue = 'Are you sure you want to leave? Your test progress may be lost.';
        return e.returnValue;
      }
    });
    
    // Performance monitoring
    if ('performance' in window) {
      window.addEventListener('load', () => {
        setTimeout(() => {
          const perfData = performance.getEntriesByType('navigation')[0];
          console.log('Enhanced page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
        }, 0);
      });
    }
  });

  // Add CSS animation for fadeOut
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  `;
  document.head.appendChild(style);
</script>

</body>
</html>