<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>PWians Test Page</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link
  href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css"
  rel="stylesheet"
/>
  <style>
:root {
  --primary-color: #1E40AF;
  --secondary-color: #2563EB;
  --accent-color: #9333EA;
  --light-bg: #F8FAFC;
  --white: #ffffff;
  --text-color: #1E293B;
  --text-secondary: #64748B;
  --card-shadow: rgba(0, 0, 0, 0.1);
  --hover-bg: rgba(30, 64, 175, 0.05);
  --border-color: #E2E8F0;
  --success-color: #10B981;
  --warning-color: #F59E0B;
  --error-color: #EF4444;
  --border-radius: 16px;
  --border-radius-sm: 8px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

body.dark-mode {
  --primary-color: #60A5FA;
  --secondary-color: #3B82F6;
  --accent-color: #C084FC;
  --light-bg: #0F172A;
  --white: #1E293B;
  --text-color: #E2E8F0;
  --text-secondary: #94A3B8;
  --card-shadow: rgba(0, 0, 0, 0.3);
  --hover-bg: rgba(96, 165, 250, 0.1);
  --border-color: #334155;
}

/* Base Reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--light-bg);
  color: var(--text-color);
  overflow-x: hidden;
  transition: var(--transition);
  line-height: 1.5;
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Mobile-first approach */
.app-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Compact Top Header */
.top-header {
  background: var(--white);
  border-bottom: 1px solid var(--border-color);
  padding: 12px 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 3px var(--card-shadow);
}

.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.header-row:last-child {
  margin-bottom: 0;
}

.user-info {
  font-size: 12px;
  color: var(--text-secondary);
}

.user-info strong {
  color: var(--text-color);
  font-weight: 600;
}

.timer-section {
  display: flex;
  align-items: center;
  gap: 8px;
}

.timer {
  background: rgba(30, 64, 175, 0.1);
  color: var(--primary-color);
  padding: 6px 12px;
  border-radius: var(--border-radius-sm);
  font-size: 13px;
  font-weight: 600;
  border: 1px solid rgba(30, 64, 175, 0.2);
}

.submit-btn {
  background: var(--primary-color);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: var(--border-radius-sm);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.submit-btn:hover {
  background: var(--secondary-color);
  transform: translateY(-1px);
}

.test-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  font-size: 11px;
}

.info-item {
  display: flex;
  flex-direction: column;
}

.info-label {
  color: var(--text-secondary);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.info-value {
  color: var(--primary-color);
  font-weight: 600;
  margin-top: 2px;
}

/* Navigation Tabs */
.nav-section {
  background: var(--white);
  border-bottom: 1px solid var(--border-color);
  padding: 0 16px;
}

.nav-tabs {
  display: flex;
  gap: 4px;
  overflow-x: auto;
  padding: 8px 0;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.nav-tabs::-webkit-scrollbar {
  display: none;
}

.nav-tab {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  white-space: nowrap;
  min-width: fit-content;
}

.nav-tab.active {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.nav-tab:hover:not(.active) {
  background: var(--hover-bg);
  border-color: var(--primary-color);
}

/* Main Content */
.main-content {
  flex: 1;
  padding: 16px;
  max-width: 100%;
}

/* Question Card */
.question-card {
  background: var(--white);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  overflow: hidden;
  box-shadow: 0 2px 8px var(--card-shadow);
  position: relative;
}

.question-header {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.question-number {
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.menu-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: var(--transition);
}

.menu-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

.question-content {
  padding: 20px;
}

.question-text {
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 20px;
  color: var(--text-color);
  font-weight: 500;
}

.question-image,
.option-image {
  max-width: 100%;
  height: auto;
  border-radius: var(--border-radius-sm);
  margin: 12px 0;
  box-shadow: 0 2px 8px var(--card-shadow);
}

/* Options */
.options-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin: 20px 0;
}

.option-item {
  background: var(--white);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  padding: 16px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.option-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 4px;
  height: 100%;
  background: var(--primary-color);
  transform: scaleY(0);
  transition: transform 0.2s ease;
}

.option-item:hover::before,
.option-item.selected::before {
  transform: scaleY(1);
}

.option-item:hover,
.option-item.selected {
  border-color: var(--primary-color);
  background: var(--hover-bg);
  transform: translateX(4px);
}

.option-content {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
}

.option-radio {
  width: 20px;
  height: 20px;
  accent-color: var(--primary-color);
  cursor: pointer;
}

.option-text {
  flex: 1;
  font-size: 14px;
  line-height: 1.5;
  cursor: pointer;
}

/* Input Answer */
.input-section {
  background: rgba(30, 64, 175, 0.05);
  border: 2px solid rgba(30, 64, 175, 0.1);
  border-radius: var(--border-radius-sm);
  padding: 16px;
  margin: 20px 0;
}

.input-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--primary-color);
  margin-bottom: 8px;
}

.input-field {
  width: 100%;
  max-width: 200px;
  padding: 12px;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  font-size: 16px;
  font-family: inherit;
  transition: var(--transition);
  background: var(--white);
}

.input-field:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

/* Review Section */
.review-section {
  background: rgba(147, 51, 234, 0.05);
  border: 2px solid rgba(147, 51, 234, 0.1);
  border-radius: var(--border-radius-sm);
  padding: 16px;
  margin: 20px 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.review-checkbox {
  width: 20px;
  height: 20px;
  accent-color: var(--accent-color);
  cursor: pointer;
}

.review-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--accent-color);
  cursor: pointer;
  flex: 1;
}

/* Navigation Buttons */
.nav-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  padding: 20px;
  background: var(--light-bg);
  border-top: 1px solid var(--border-color);
}

.nav-btn {
  padding: 14px 20px;
  border: none;
  border-radius: var(--border-radius-sm);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-height: 48px;
}

.nav-btn.primary {
  background: var(--primary-color);
  color: white;
}

.nav-btn.secondary {
  background: var(--white);
  color: var(--text-color);
  border: 2px solid var(--border-color);
}

.nav-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--card-shadow);
}

.nav-btn.primary:hover {
  background: var(--secondary-color);
}

.nav-btn.secondary:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
}

/* Progress Modal */
.progress-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(8px);
  z-index: 1000;
  display: none;
  padding: 20px;
}

.progress-content {
  background: var(--white);
  border-radius: var(--border-radius);
  max-width: 400px;
  margin: 0 auto;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  margin-top: 10vh;
}

.progress-header {
  background: var(--primary-color);
  color: white;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.progress-title {
  font-size: 16px;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.progress-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  padding: 20px;
}

.progress-item {
  aspect-ratio: 1;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  background: var(--white);
  min-height: 40px;
}

.progress-item:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px var(--card-shadow);
}

.progress-actions {
  padding: 20px;
  border-top: 1px solid var(--border-color);
}

.progress-submit {
  width: 100%;
  background: var(--primary-color);
  color: white;
  border: none;
  padding: 12px;
  border-radius: var(--border-radius-sm);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.progress-submit:hover {
  background: var(--secondary-color);
}

/* Username Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  z-index: 1100;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  opacity: 0;
  animation: fadeIn 0.3s forwards;
}

.modal {
  background: var(--white);
  border-radius: var(--border-radius);
  padding: 32px 24px;
  width: 100%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideUp 0.3s ease-out;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 20px;
}

.modal-input {
  width: 100%;
  padding: 16px;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  font-size: 16px;
  font-family: inherit;
  margin-bottom: 20px;
  transition: var(--transition);
}

.modal-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.modal-btn {
  width: 100%;
  background: var(--primary-color);
  color: white;
  border: none;
  padding: 16px;
  border-radius: var(--border-radius-sm);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.modal-btn:hover {
  background: var(--secondary-color);
  transform: translateY(-2px);
}

/* Dark Mode Toggle */
.theme-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 12px var(--card-shadow);
  z-index: 999;
  border: none;
  transition: var(--transition);
}

.theme-toggle:hover {
  transform: scale(1.1);
}

.theme-toggle i {
  font-size: 20px;
}

/* Animations */
@keyframes fadeIn {
  to { opacity: 1; }
}

@keyframes modalSlideUp {
  from { transform: translateY(20px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

/* Status Colors */
.status-answered { background: var(--success-color) !important; color: white !important; }
.status-review { background: var(--accent-color) !important; color: white !important; }
.status-visited { background: var(--warning-color) !important; color: white !important; }
.status-answered-review { background: var(--text-secondary) !important; color: white !important; }

/* Tablet Styles */
@media (min-width: 768px) {
  body { font-size: 16px; }
  
  .top-header {
    padding: 16px 24px;
  }
  
  .header-row {
    margin-bottom: 12px;
  }
  
  .test-info {
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }
  
  .main-content {
    padding: 24px;
    max-width: 800px;
    margin: 0 auto;
  }
  
  .question-content {
    padding: 32px;
  }
  
  .question-text {
    font-size: 18px;
  }
  
  .nav-buttons {
    padding: 24px 32px;
  }
  
  .progress-modal {
    padding: 40px;
  }
  
  .progress-content {
    max-width: 500px;
    margin-top: 5vh;
  }
  
  .progress-grid {
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    padding: 24px;
  }
}

/* Desktop Styles */
@media (min-width: 1024px) {
  .app-container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .top-header {
    padding: 20px 32px;
  }
  
  .test-info {
    grid-template-columns: repeat(5, 1fr);
  }
  
  .main-content {
    padding: 32px;
  }
  
  .nav-buttons {
    grid-template-columns: 1fr 2fr;
    gap: 20px;
  }
  
  .progress-content {
    max-width: 600px;
  }
  
  .progress-grid {
    grid-template-columns: repeat(8, 1fr);
  }
}

/* Touch improvements */
@media (hover: none) and (pointer: coarse) {
  .nav-tab,
  .option-item,
  .nav-btn,
  .progress-item {
    min-height: 44px;
  }
  
  .menu-btn {
    width: 44px;
    height: 44px;
  }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Focus styles */
button:focus,
input:focus,
.option-item:focus-within {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* Loading states */
.loading {
  opacity: 0.6;
  pointer-events: none;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid var(--primary-color);
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Compact Top Header -->
    <header class="top-header">
      <div class="header-row">
        <div class="user-info">
          <strong id="logged-username">--</strong> • <span id="logged-batch">--</span>
        </div>
        <div class="timer-section">
          <div class="timer" id="timer">
            <i class="fas fa-clock"></i>
            <span id="time-left">00:00:00</span>
          </div>
          <button class="submit-btn" onclick="submitTest()">
            <i class="fas fa-paper-plane"></i> Submit
          </button>
        </div>
      </div>
      <div class="test-info">
        <div class="info-item">
          <span class="info-label">Test</span>
          <span class="info-value" id="test-name">--</span>
        </div>
        <div class="info-item">
          <span class="info-label">Subject</span>
          <span class="info-value" id="current-subject">--</span>
        </div>
        <div class="info-item">
          <span class="info-label">Question</span>
          <span class="info-value">
            <span id="current-question-index">0</span>/<span id="total-questions">0</span>
          </span>
        </div>
      </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-section">
      <div class="nav-tabs" id="subject-buttons"></div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="content" style="filter: blur(5px);">
      <div class="question-card" id="question-card">
        <div class="question-header">
          <div class="question-number">Question 1</div>
          <button class="menu-btn" onclick="toggleProgress()">
            <i class="fas fa-bars"></i>
          </button>
        </div>
        <div class="question-content">
          <p>Loading question...</p>
        </div>
      </div>
    </main>

    <!-- Dark Mode Toggle Button -->
    <button class="theme-toggle" id="theme-toggle">
      <i class="fas fa-moon"></i>
    </button>
  </div>

  <!-- Progress Modal -->
  <div class="progress-modal" id="progress-modal">
    <div class="progress-content">
      <div class="progress-header">
        <h3 class="progress-title">Question Progress</h3>
        <button class="close-btn" onclick="toggleProgress()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="progress-grid" id="question-progress"></div>
      <div class="progress-actions">
        <button class="progress-submit" onclick="submitTest()">
          <i class="fas fa-paper-plane"></i> Submit Test
        </button>
      </div>
    </div>
  </div>

  <!-- Username Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2 class="modal-title">Welcome to PWians Test</h2>
      <input type="text" class="modal-input" id="username" placeholder="Enter your username">
      <button class="modal-btn" onclick="validateCredentials()">
        <i class="fas fa-arrow-right"></i> Start Test
      </button>
    </div>
  </div>
<!-- 1) MathJax config (before loading mathjax.js!) -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']],
      displayMath: [['$$', '$$']]
    },
    options: {
      skipHtmlTags: ['script','noscript','style','textarea','pre','code']
    },
    startup: {
      ready: () => {
        MathJax.startup.defaultReady();
        if (window.Prism) Prism.highlightAll();
      }
    }
  };
</script>

<!-- 2) Load MathJax -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- 3) Load Prism (for LaTeX code highlighting) -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-latex.min.js"></script>

<!-- 4) All your application logic in one place -->
<script>
  // ─────────────────────────────────────────────────────────────────────────────
  // A) Wrap “bare” LaTeX in delimiters for MathJax
  // ─────────────────────────────────────────────────────────────────────────────
  function renderLatex(str) {
    if (!str || typeof str !== "string") return "—";
    const already =
         /\\\(.+?\\\)/.test(str)
      || /\\\[.+?\\\]/.test(str)
      || /\$\$[\s\S]+?\$\$/.test(str)
      || /\\begin\{.*?\}[\s\S]*?\\end\{.*?\}/.test(str);
    if (already) return str;
    const looksLike = /\\[a-zA-Z]+|[_^{}]|\\begin|\\end/.test(str);
    return looksLike ? `\\(${str}\\)` : str;
  }

  // Ensure any <code class="language-latex"> is highlighted
  document.addEventListener('DOMContentLoaded', () => {
    if (window.Prism) Prism.highlightAll();
  });

  // ─────────────────────────────────────────────────────────────────────────────
  // B) Read URL params & initialize state
  // ─────────────────────────────────────────────────────────────────────────────
  const params            = new URLSearchParams(window.location.search);
  const testID            = params.get("test")      || "";
  let   batchName         = params.get("batchName") || "";
  let   username          = "";

  let   testData          = {};
  let   subjectsArr       = [];
  let   questions         = [];
  let   currentSubject    = "";
  let   currentQuestionIndex = 0;
  let   timeLeft          = 0, timerInterval    = null;
  let   tabSwitchCount    = 0, maxTabSwitches  = 5;
  let   isDarkMode        = localStorage.getItem('darkMode') === 'true';

  // ─────────────────────────────────────────────────────────────────────────────
  // C) Dark mode toggle
  // ─────────────────────────────────────────────────────────────────────────────
  if (isDarkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
  }
  document.getElementById('theme-toggle').addEventListener('click', () => {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode', isDarkMode);
    document.getElementById('theme-toggle').innerHTML =
      isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    localStorage.setItem('darkMode', isDarkMode);
  });

  // ─────────────────────────────────────────────────────────────────────────────
  // D) Login handler (called by your Login button: <button onclick="validateCredentials()">)
  // ─────────────────────────────────────────────────────────────────────────────
  window.validateCredentials = async function() {
    const u = document.getElementById("username")?.value.trim();
    if (!u) return showToast("Please enter your username.", "error");
    username = u;
    document.getElementById("logged-username").textContent = u;
    document.getElementById("modal-overlay").style.display = "none";
    document.getElementById("content").style.filter = "none";
    await loadTestSeriesData();
  };

  // ─────────────────────────────────────────────────────────────────────────────
  // E) Show batch code
  // ─────────────────────────────────────────────────────────────────────────────
  document.getElementById("logged-batch").textContent = batchName;

  // ─────────────────────────────────────────────────────────────────────────────
// F) Fetch test data, subjects, timer, then load questions
// ─────────────────────────────────────────────────────────────────────────────
async function loadTestSeriesData() {
  try {
    showLoading(true);
    const res = await fetch(`/api/testSeries/${testID}`);  // ✅ Ensure this route is correct
    if (!res.ok) throw new Error("Fetch failed");
    testData = await res.json();

    // ✅ Show test name and subject buttons
    document.getElementById("test-name").textContent = testData.testName;
    subjectsArr = testData.subjects || [];

    // ✅ Use consistent key
    const key = `startTime_${testID}`;

    // ✅ Timer duration logic
    const raw = testData.testDuration ?? 90;
    const mins = Number.isInteger(+raw) ? +raw : 90;
    const totalSec = mins * 60;

    let startTs = localStorage.getItem(key);
    if (!startTs) {
      startTs = Date.now().toString();
      localStorage.setItem(key, startTs);
      console.log("Timer STARTED at:", startTs);
    } else {
      console.log("Timer already started at:", startTs);
    }

    const elapsed = Math.floor((Date.now() - parseInt(startTs, 10)) / 1000);
    timeLeft = Math.max(totalSec - elapsed, 0);
    console.log(`Total=${totalSec}s, Elapsed=${elapsed}s, Remaining=${timeLeft}s`);

    buildSubjectButtons();
    currentSubject = subjectsArr[0] || "";
    await loadQuestions();

    updateTimerDisplay();
    startTimer();
  } catch (e) {
    console.error(e);
    showToast("Failed to load test. Please refresh.", "error");
  } finally {
    showLoading(false);
  }
}

  // ─────────────────────────────────────────────────────────────────────────────
  // G) Build subject tabs
  // ─────────────────────────────────────────────────────────────────────────────
  function buildSubjectButtons() {
    const c = document.getElementById("subject-buttons");
    c.innerHTML = "";
    subjectsArr.forEach(sub => {
      const btn = document.createElement("button");
      btn.className = "nav-tab";
      btn.textContent = sub;
      btn.onclick = () => {
        currentSubject = sub;
        updateSubjectButtons();
        loadQuestions();
      };
      c.appendChild(btn);
    });
    updateSubjectButtons();
  }
  function updateSubjectButtons() {
    document.querySelectorAll("#subject-buttons .nav-tab")
      .forEach(b => b.classList.toggle("active", b.textContent === currentSubject));
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // H) Load & render questions
  // ─────────────────────────────────────────────────────────────────────────────
  async function loadQuestions() {
    showLoading(true);
    const qMap = testData.questions[currentSubject] || {};
    questions = Object.values(qMap).sort((a,b) => {
      const ai = Array.isArray(a.options)&&a.options.length;
      const bi = Array.isArray(b.options)&&b.options.length;
      return (ai?0:1)-(bi?0:1);
    });
    currentQuestionIndex = 0;
    if (questions.length) markAsVisited(questions[0].questionId);
    displayQuestion();
    updateNavInfo();
    updateProgress();
    showLoading(false);
  }

  function displayQuestion() {
    const q = questions[currentQuestionIndex];
    const c = document.getElementById("question-card");
    if (!q) {
      c.innerHTML = "<p>No questions in this section.</p>";
      return;
    }

    const isImageURL = str => /^https?:\/\/.*\.(png|jpe?g|gif|svg)$/i.test(str);
    const saved       = getSavedAnswer(q.questionId);
    const reviewed    = getSavedReview(q.questionId);

    let html = `
      <div class="question-header">
        <div class="question-number">Question ${currentQuestionIndex+1}</div>
        <button class="menu-btn" onclick="toggleProgress()"><i class="fas fa-bars"></i></button>
      </div>
      <div class="question-content">
        <div class="question-text">
          ${isImageURL(q.question)
            ? `<img src="${q.question}" class="question-image"/>`
            : renderLatex(q.question)}
        </div>
        <div class="review-section">
          <input type="checkbox" id="review-checkbox" ${reviewed?"checked":""}/>
          <label for="review-checkbox"><i class="fas fa-bookmark"></i> Mark for Review</label>
        </div>`;

    if (Array.isArray(q.options) && q.options.length) {
      html += `<div class="options-container">`;
      q.options.forEach((opt,i) => {
        const L = String.fromCharCode(65+i);
        const sel = saved===L ? 'selected' : '';
        html += `
          <div class="option-item ${sel}" onclick="selectOption('${q.questionId}','${L}',this)">
            <div class="option-content">
              <input type="radio" name="opt_${q.questionId}" value="${L}" ${sel?"checked":""}/>
              <div class="option-text">
                ${isImageURL(opt)?`<img src="${opt}"/>`:`${L}. ${renderLatex(opt)}`}
              </div>
            </div>
          </div>`;
      });
      html += `</div>`;
    } else {
      html += `
        <div class="input-section">
          <label><i class="fas fa-edit"></i> Your Answer:</label>
          <input type="number" id="answer-input" value="${saved}" placeholder="Enter answer"/>
        </div>`;
    }

    html += `
        <div class="nav-buttons">
          <button class="nav-btn secondary" onclick="goToPrevious()" ${currentQuestionIndex===0?'disabled':''}>
            <i class="fas fa-arrow-left"></i> Previous
          </button>
          <button class="nav-btn primary" onclick="saveAndNext()">
            ${currentQuestionIndex===questions.length-1?'Save & Finish':'Save & Next'}
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>`;

    c.innerHTML = html;
    if (window.MathJax) MathJax.typesetPromise([c]).catch(console.error);
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // I) Handlers: selectOption, saveAndNext, goToPrevious, progress, storage…
  // ─────────────────────────────────────────────────────────────────────────────
  function selectOption(q,val,el){
    document.querySelectorAll('.option-item').forEach(x=>x.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input').checked = true;
    saveAnswer(q,val);
  }
  function handleOptionChange(e,q){ saveAnswer(q,e.target.value); }

  window.saveAndNext = () => {
    const q = questions[currentQuestionIndex];
    const inp = document.getElementById("answer-input");
    if (inp) { const v=inp.value.trim(); v?saveAnswer(q.questionId,v):removeAnswer(q.questionId); }
    const cb = document.getElementById("review-checkbox");
    if (cb) saveReview(q.questionId,cb.checked);

    if (currentQuestionIndex<questions.length-1) {
      currentQuestionIndex++;
      markAsVisited(questions[currentQuestionIndex].questionId);
    } else {
      const idx = subjectsArr.indexOf(currentSubject);
      if (idx<subjectsArr.length-1) {
        currentSubject = subjectsArr[idx+1];
        updateSubjectButtons();
        loadQuestions(); return;
      } else {
        showToast("All questions complete!","success");
        return;
      }
    }
    displayQuestion(); updateNavInfo(); updateProgress();
  };

  window.goToPrevious = () => {
    if (currentQuestionIndex>0) {
      currentQuestionIndex--;
      displayQuestion(); updateNavInfo(); updateProgress();
    }
  };

  function updateNavInfo(){
    document.getElementById("current-subject").textContent = currentSubject;
    document.getElementById("current-question-index").textContent = currentQuestionIndex+1;
    document.getElementById("total-questions").textContent = questions.length;
  }

  function updateProgress(){
    const c = document.getElementById("question-progress"); c.innerHTML = "";
    questions.forEach((q,i)=>{
      const itm = document.createElement("div");
      itm.className = "progress-item";
      itm.textContent = i+1;
      const has = !!getSavedAnswer(q.questionId);
      const rev = getSavedReview(q.questionId);
      const vis = getSavedVisited(q.questionId);
      if (has&&rev) itm.classList.add("status-answered-review");
      else if (has) itm.classList.add("status-answered");
      else if (rev) itm.classList.add("status-review");
      else if (vis) itm.classList.add("status-visited");
      itm.onclick = ()=>{
        currentQuestionIndex = i;
        markAsVisited(q.questionId);
        displayQuestion(); updateNavInfo(); updateProgress(); toggleProgress();
      };
      c.appendChild(itm);
    });
  }

  window.toggleProgress = () => {
    const m = document.getElementById("progress-modal");
    m.style.display = (m.style.display==="block"?"none":"block");
    if (m.style.display==="block") updateProgress();
  };

  function saveAnswer(q,a){
    localStorage.setItem(`response_${currentSubject}_${q}`,a);
  }
  function getSavedAnswer(q){
    return localStorage.getItem(`response_${currentSubject}_${q}`) || "";
  }
  function removeAnswer(q){
    localStorage.removeItem(`response_${currentSubject}_${q}`);
  }

  function saveReview(q,f){
    f?
      localStorage.setItem(`review_${currentSubject}_${q}`,"true") :
      localStorage.removeItem(`review_${currentSubject}_${q}`);
  }
  function getSavedReview(q){
    return localStorage.getItem(`review_${currentSubject}_${q}`)==="true";
  }

  function markAsVisited(q){
    localStorage.setItem(`visited_${currentSubject}_${q}`,"true");
  }
  function getSavedVisited(q){
    return localStorage.getItem(`visited_${currentSubject}_${q}`)==="true";
  }

 // J) Timer + auto-submit
// ─────────────────────────────────────────────────────────────────────────────

function updateTimerDisplay() {
  const h = Math.floor(timeLeft / 3600),
        m = Math.floor((timeLeft % 3600) / 60),
        s = timeLeft % 60;
  const txt = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  const el = document.getElementById("time-left");
  const tm = document.getElementById("timer");

  if (el) el.textContent = txt;
  if (tm) {
    if (timeLeft <= 300) {
      tm.style.cssText = "background:rgba(239,68,68,0.1);color:var(--error-color);border-color:var(--error-color)";
    } else if (timeLeft <= 600) {
      tm.style.cssText = "background:rgba(245,158,11,0.1);color:var(--warning-color);border-color:var(--warning-color)";
    }
  }
}

function startTimer() {
  stopTimer(); // Ensure previous interval is cleared
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      stopTimer();
      submitTest(true); // Auto-submit
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval !== null) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}
  document.addEventListener("visibilitychange",()=>{
    if (document.hidden){
      tabSwitchCount++;
      if (tabSwitchCount>=maxTabSwitches) submitTest(true);
      else showToast(`Warning: ${maxTabSwitches-tabSwitchCount} tab switches remaining before auto‐submit.`,"warning");
    }
  });

// ─────────────────────────────────────────────────────────────────────────────
// J) submitTest (manual & auto)
// ─────────────────────────────────────────────────────────────────────────────
window.submitTest = async function(auto = false) {
  const urlParams = new URLSearchParams(window.location.search);
  const testID = urlParams.get('test');
  const batchName = urlParams.get('batchName') || urlParams.get('batch');
  const username = localStorage.getItem('username') || "anonymous";

  if (!testID || !batchName || !username) {
    console.error("Missing testID, batchName, or username");
    return showToast("Submission failed: Missing required info", "error");
  }

  // Remove timer tracking key
  localStorage.removeItem(`startTime_${testID}`);

  if (!auto && !confirm("Are you sure you want to submit the test?")) {
    return;
  }

  try {
    showLoading(true);

    // 🔹 Collect answers from your UI (you should replace this logic as per your structure)
    const responses = collectUserResponses(); // <-- Replace with your actual response collection logic

    const resp = await fetch(`/api/tests/${testID}/submit`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ batchName, username, responses })
    });

    if (!resp.ok) throw new Error(`Submission failed: ${resp.status}`);
    const data = await resp.json();

    localStorage.clear();
    clearInterval(timerInterval);

    showToast(auto ? "Auto-submitted!" : "Submitted successfully!", "success");

    setTimeout(() => {
      location.href = auto
        ? "/Results/"
        : `/Results/?test=${testID}&batch=${encodeURIComponent(batchName)}&username=${encodeURIComponent(username)}`;
    }, 2000);
  } catch (e) {
    console.error(e);
    showToast("Failed to submit. Try again.", "error");
    showLoading(false);
  }
};

  function showLoading(on){
    const c=document.getElementById("content");
    on?c.classList.add("loading"):c.classList.remove("loading");
  }
  function showToast(msg,type="info"){
    const t=document.createElement("div");
    t.style.cssText=`position:fixed;top:20px;right:20px;background:${
      type==="error"?"var(--error-color)":type==="warning"?"var(--warning-color)":"var(--success-color)"
    };color:white;padding:12px 20px;border-radius:4px;z-index:10000;transform:translateX(100%);transition:transform .3s`;
    t.textContent=msg;document.body.appendChild(t);
    setTimeout(()=>t.style.transform="translateX(0)",100);
    setTimeout(()=>{t.style.transform="translateX(100%)";setTimeout(()=>t.remove(),300);},3000);
  }

  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowLeft'&&currentQuestionIndex>0){ e.preventDefault(); goToPrevious(); }
    else if(e.key==='ArrowRight'){ e.preventDefault(); saveAndNext(); }
    else if(e.key==='Escape'){ const m=document.getElementById("progress-modal"); if(m.style.display==="block") toggleProgress(); }
  });

  let touchStartX=0,touchEndX=0;
  document.addEventListener('touchstart',e=>touchStartX=e.changedTouches[0].screenX);
  document.addEventListener('touchend',e=>{ touchEndX=e.changedTouches[0].screenX; const d=touchStartX-touchEndX; if(Math.abs(d)>50) d>0?saveAndNext():goToPrevious(); });
  
  document.addEventListener('DOMContentLoaded',()=>{
    const inp=document.getElementById("username");
    if(inp){ inp.focus(); inp.addEventListener('keypress',e=>{ if(e.key==='Enter') validateCredentials(); }); }
  });

  function collectUserResponses() {
  const batchSelect = document.getElementById("batch");
  const testSelect = document.getElementById("test");
  const subjectSelect = document.getElementById("subject");
  const questionPDF = document.getElementById("questionPdf").files[0];
  const solutionPDF = document.getElementById("solutionPdf").files[0];

  if (!batchSelect.value || !testSelect.value || !subjectSelect.value || !questionPDF || !solutionPDF) {
    showNotification("Error", "Please fill all fields and upload both PDFs.", "danger");
    return null;
  }

  const formData = new FormData();
  formData.append("batchId", batchSelect.value);
  formData.append("testId", testSelect.value);
  formData.append("subject", subjectSelect.value);
  formData.append("questionPdf", questionPDF);
  formData.append("solutionPdf", solutionPDF);

  return formData;
}

</script>


</body>
</html>
